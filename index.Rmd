---
title: "Covid-19 no Brasil"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    theme: united
    logo: coronavirus.png
    #source_code: embed
    #favicon: coronavirus.png
    #navbar:
    #  - {icon: "fa-archive", title: "Banco de Dados", href: "https://brasil.io/covid19/", align: right}
    navbar:
      - {icon: "fa-linkedin", title: "Tiago Cruz", href: "https://www.linkedin.com/in/tiago-cruz-b65721284/", align: right}
    source: "https://github.com/Tiago-HCruz/Covid-19_Brasil/blob/main/index.Rmd"
lang: pt-BR
---

<style> 

body {
  background: RGB(250, 192, 105, 0.5);  /* Cor de fundo */
  /* color: #152028;   text color */
  font-family: Gill Sans, sans-serif;
  padding: 60px 0 0 8px; /* padding-top overridden by theme */
}

.chart-wrapper {
  background: #fff;
  border: 1px solid #000000;
  border-radius: 3px;
  margin-bottom: 8px;
  margin-right: 8px;
}

.chart-title {
  border-bottom: 1px solid #fff; 
  color: #000000;
  font-size: 16px;
  font-weight: 300;
  padding: 7px 10px 4px;
}

.chart-wrapper .chart-notes {
  background: #000000;
  border-top: 1px solid #000000;
  color: #000000;
  font-size: 12px;
  padding: 8px 10px 5px;
}

.chart-stage .table-bordered > tbody > tr > td {
  border-top: 1px solid #000000;
}

.chart-stage .table-bordered > thead > tr > th {
  border: none;
  border-bottom: 2px solid #000000;
}
/* Value box */

.value-box {
  border-radius: 2px;
  position: relative;
  display: block;
  margin-right: 8px;
  margin-bottom: 8px;
  box-shadow: 0 2px 2px rgba(0, 0, 0, 0.5);
}

/* NAV TABS */

.nav-tabs-custom {
  background: #fff;
  border: 1px solid #000;
  border-radius: 3px;
  margin-bottom: 8px;
  margin-right: 8px;
}

.nav-tabs-custom > .nav-tabs {
  margin: 0;
  border-bottom: 1px solid #000000;
  color: #992244; 
  font-size: 10px;
  font-weight: 300;
  border-top-right-radius: 3px;
  border-top-left-radius: 3px;
}

.nav-tabs-custom > .nav-tabs > li > a,
.nav-tabs-custom > .nav-tabs > li > a:active {
  color: #666;
  font-weight: 300;
  font-size: 16px;
  border-radius: 0;
  padding: 3px 10px 5px;
  text-transform: none;
}

.nav-tabs-custom > .nav-tabs > li > a.text-muted {
  color: #000;
}

.nav-tabs-custom > .nav-tabs > li.active > a,
.nav-tabs-custom > .nav-tabs > li.active:hover > a {
  background-color: #fff;
  color: #000;
}

.nav-tabs-custom > .nav-tabs > li.active > a {
  border-top-color: transparent;
  border-left-color: #000000;
  border-right-color: #000000;
}

.nav-tabs-custom > .nav-tabs > li.active:hover > a {
  background-color: #fff;
  color: #000000;
}

.nav-tabs-custom > .nav-tabs > li.active {
  border-top-color: #992244;
}

.value-box {
  color: inherit;
  background-color: ##CD5C5C;

}

</style>  

```{r}
knitr::opts_chunk$set(
  cache = F
)
```

```{r setup, include=FALSE}
library(flexdashboard)
library(readr)
library(ggplot2)
library(tidyverse)
library(readxl)
library(ggcal)
library(htmlwidgets)
library(IRdisplay)
library(leaflet)
library(RSQLite)
library(fmsb)
library(plotly)
library(cowplot)
library(scales)
library(ggwordcloud)
library(colorspace)
library(gtrendsR)
library(leaflet.extras)
library(treemap)
```

```{r Diretorio, include=FALSE}
path <- getwd()
#date:
#   "`r paste('Atualização:', format(Sys.time() - as.difftime(1, units = 'days'), '%d/%m/%Y'))`"
```

```{r Banco de Dados, include=FALSE}
db <- dbConnect(SQLite(), file.path(path, "Covid19_Brasil.sqlite3"))
#dbDisconnect(db)
```

```{r Local_Estado, include=FALSE}
if(!"Local_Estado" %in% dbListTables(db)){
  dbWriteTable(db, "Local_Estado",
               read_csv("https://raw.githubusercontent.com/kelvins/Municipios-Brasileiros/main/csv/estados.csv") %>%
                 rename(`Código UF` = codigo_uf,
                        UF = uf, Estado = nome,
                        Latitude = latitude,
                        Longitude = longitude),
               append = TRUE)
}

#dbGetQuery(db, paste("SELECT * FROM Local_Estado"))
#dbGetQuery(db, paste("DROP TABLE Local_Estado"))

```

```{r Local_Cidade, include=FALSE}

dbWriteTable(db, "Local_Cidade",
               read_csv("https://raw.githubusercontent.com/kelvins/Municipios-Brasileiros/main/csv/municipios.csv") %>%
                 rename(`Código da Cidade` = codigo_ibge,
                        Cidade = nome,
                        Latitude = latitude,
                        Longitude = longitude),
               append = TRUE)

#dbGetQuery(db, paste("SELECT * FROM Local_Cidade"))
#dbGetQuery(db, paste("DROP TABLE Local_Cidade"))
```

```{r Caso_Atualizado_Estado, include=FALSE}

if(!"Caso_Atualizado_Estado" %in% dbListTables(db)){
  
  Ler_caso_atul_est <- function(input, pos){
  
  df <- input %>%
    filter(place_type %in% "state" &
             is_last == TRUE) %>%
    select(-c(place_type, is_last)) %>%
    mutate(confirmed_per_100k_inhabitants = 
             round(confirmed_per_100k_inhabitants),
           `Óbitos por 100 mil Hab` = 
             round((deaths/estimated_population)*100000)) %>%
    rename(Data = date, UF = state, 
           `Código do Estado (IBGE)` = city_ibge_code, 
           `Casos Confirmados` = confirmed,
           `Óbitos` = deaths, 
           `População Estimada` = estimated_population,
           `Casos Confirmados por 100 mil Hab` = confirmed_per_100k_inhabitants,
           Letalidade = death_rate)
    
  
  dbWriteTable(db, "Caso_Atualizado_Estado", df, append = TRUE)}

  read_csv_chunked("https://data.brasil.io/dataset/covid19/caso.csv.gz",
                 chunk_size = 1e3,
                 col_types = cols_only(date = "c",
                                       place_type = "c",
                                       state = "c",
                                       city_ibge_code = "i",
                                       confirmed = "i",
                                       deaths = "i",
                                       estimated_population = "i",
                                       confirmed_per_100k_inhabitants = "d",
                                       death_rate = "d",
                                       is_last = "l"),
                 callback=SideEffectChunkCallback$new(Ler_caso_atul_est))
}

#dbGetQuery(db, paste("SELECT * FROM Caso_Atualizado_Estado"))
#dbListTables(db)
#dbGetQuery(db, paste("DROP TABLE Caso_Atualizado_Estado"))

```

```{r Caso_Novos_Estados, include=FALSE}

if(!"Caso_Novos_Estados" %in% dbListTables(db)){
  
  Ler_Caso_Novos_Estados <- function(input, pos){
    
    df <- input %>%
      filter(place_type %in% "state" &
               is_repeated == F) %>%
      select(-c("place_type", "is_repeated")) %>%
      rename(Data = last_available_date, `Código do Estado` = city_ibge_code,
             UF = state, `Novos Casos` = new_confirmed,
             `Novos Óbitos` = new_deaths)
    
     dbWriteTable(db, "Caso_Novos_Estados", df, append = TRUE)
     
  }
  
  read_csv_chunked("https://data.brasil.io/dataset/covid19/caso_full.csv.gz",
                   chunk_size = 1e3,
                   col_types = cols_only(last_available_date = "c",
                                       state = "c",
                                       city_ibge_code = "d",
                                       place_type = "c",
                                       new_confirmed = "i",
                                       new_deaths = "i",
                                       is_last = "l",
                                       is_repeated = "l"),
                  
                
                callback=SideEffectChunkCallback$new( Ler_Caso_Novos_Estados))
}
                 
#dbListTables(db)
#dbGetQuery(db, paste("SELECT * FROM Caso_Novos_Estados"))
#dbGetQuery(db, paste("DROP TABLE Caso_Novos_Estados"))
```

```{r Caso_Acum_Estados, include=FALSE}

if(!"Caso_Acum_Estados" %in% dbListTables(db)){
  Ler_Caso_Acum_Estados <- function(input, pos){
  
    df <- input %>%
      filter(place_type %in% "state" #&
               #is_repeated == F
             ) %>%
      select(-c("place_type"#, "is_repeated"
                )) %>%
      rename(Data = date,
             `Código do Estado` = city_ibge_code,
             UF = state,
             `Casos Acum.` = last_available_confirmed,
             `Óbitos Acum.` = last_available_deaths)
    
    dbWriteTable(db, "Caso_Acum_Estados", df, append = TRUE)

    }

  read_csv_chunked("https://data.brasil.io/dataset/covid19/caso_full.csv.gz",
                   chunk_size = 1e3,
                   col_types = cols_only(date = "c",
                                         state = "c",
                                         city_ibge_code = "d",
                                         place_type = "c",
                                         last_available_confirmed = "i",
                                         last_available_deaths = "i",
                                         is_last = "l",
                                         is_repeated = "l"),
                  
                
                   callback=SideEffectChunkCallback$new(
                     Ler_Caso_Acum_Estados))
}

#dbListTables(db)
#dbGetQuery(db, paste("SELECT * FROM Caso_Acum_Estados"))
#dbGetQuery(db, paste("DROP TABLE Caso_Acum_Estados"))
```

```{r Caso_Novos_Cidades, include=FALSE}
if(!"Caso_Novos_Cidades" %in% dbListTables(db)){
  
    Ler_Caso_Novos_Cidades <- function(input, pos){
    
    df <- input %>%
      filter(place_type %in% "city" &
               is_repeated == F
             ) %>%
      select(-c("place_type", "is_repeated"
                )) %>%
      rename(Data = last_available_date, 
             `Código da Cidade` = city_ibge_code,
             UF = state, `Novos Casos` = new_confirmed,
             `Novos Óbitos` = new_deaths,
             Cidade = city) %>%
      unite(Cidade_UF, c("Cidade", "UF"), sep = " - ") %>%
      mutate(Cidade_UF = str_replace_all(Cidade_UF, "[']", "´"),
             `Novos Casos` = ifelse(`Novos Casos` < 0, NA,
                                    `Novos Casos`),
             `Novos Óbitos` = ifelse(`Novos Óbitos` < 0, NA,
                                     `Novos Óbitos`))
    
     dbWriteTable(db, "Caso_Novos_Cidades", df, append = TRUE)
     
  }

  read_csv_chunked("https://data.brasil.io/dataset/covid19/caso_full.csv.gz",
                   chunk_size = 1e3,
                   col_types = cols_only(city = "c",
                                         last_available_date = "c",
                                         state = "c",
                                         city_ibge_code = "d",
                                         place_type = "c",
                                         new_confirmed = "i",
                                         new_deaths = "i",
                                         is_last = "l",
                                         is_repeated = "l"
                                         ),
                   callback=SideEffectChunkCallback$new(
                     Ler_Caso_Novos_Cidades))  
  
}

#dbListTables(db)
#dbGetQuery(db, paste("SELECT * FROM Caso_Novos_Cidades"))
#dbGetQuery(db, paste("DROP TABLE Caso_Novos_Cidades"))
```

```{r Caso_Acum_Cidade, include=FALSE}

if(!"Caso_Acum_Cidade" %in% dbListTables(db)){
  
    Ler_Caso_Acum_Cidade <- function(input, pos){
    
    df <- input %>%
      filter(place_type %in% "city" &
               is_repeated == F
               ) %>%
      select(-c("place_type", "is_repeated")) %>%
      rename(Data = date, 
             `Código da Cidade` = city_ibge_code,
             Letalidade = last_available_death_rate,
             UF = state, 
             `Casos Acumulado` = last_available_confirmed,
             `Óbitos Acumulado` = last_available_deaths,
             `População Estimada` = estimated_population,
             Cidade = city,
              `Caso por 100 Mil Habitantes` = last_available_confirmed_per_100k_inhabitants
             ) %>%
      unite(Cidade_UF, c("Cidade", "UF"), sep = " - ") %>%
      mutate(Cidade_UF = str_replace_all(Cidade_UF, "[']", "´"))
    
    dbWriteTable(db, "Caso_Acum_Cidade", df, append = TRUE)}
    
  read_csv_chunked("https://data.brasil.io/dataset/covid19/caso_full.csv.gz",
                   chunk_size = 1e3,
                   col_types = cols_only(city = "c",
                                         date = "c",
                                         state = "c",
                                         city_ibge_code = "d",
                                         place_type = "c",
                                         last_available_confirmed = "i",
                                         last_available_deaths = "i", 
                                         last_available_confirmed_per_100k_inhabitants = "d",
                                         last_available_death_rate = "d",
                                         is_last = "l",
                                         is_repeated = "l",
                                         estimated_population = "d"
                                         ),
                   callback=SideEffectChunkCallback$new(
                     Ler_Caso_Acum_Cidade)) 
  
}

#dbListTables(db)
#dbGetQuery(db, paste("SELECT * FROM Caso_Acum_Cidade"))
#dbGetQuery(db, paste("DROP TABLE Caso_Acum_Cidade"))
```

```{r Fontes, include=FALSE}

if(!"Fontes" %in% dbListTables(db)){
  
  Ler_Fontes <- function(input, pos){
  input %>%
  separate(url, c("endereco", "complementar", "fonte"), sep = "/") %>%
  mutate(fonte = str_replace(fonte,"www.", ""),
         fonte = str_replace(fonte,".gov.br", ""),
         fonte = str_replace(fonte,".com", "")) %>%
  filter(fonte %in% 
             str_subset(fonte,"^[1:9]", negate = TRUE)) %>%
  group_by(fonte) %>%
  summarise(Frequencia = n())
}

dbWriteTable(db, 
             "Fontes",
             read_csv_chunked("https://data.brasil.io/dataset/covid19/boletim.csv.gz",
                              chunk_size = 1e3,
                              col_types = 
                                cols_only(notes = "c",
                                          state = "c",
                                          url = "c"),
callback=DataFrameCallback$new(Ler_Fontes)) %>%
  group_by(fonte) %>%
  summarise(Frequencia = sum(Frequencia)), 
append = TRUE)

}

#dbListTables(db)
#dbGetQuery(db, paste("SELECT * FROM Fontes"))
#dbGetQuery(db, paste("DROP TABLE Fontes"))
```

Situação Geral {data-icon="fa-diagnoses"} 
===

Column {data-width=200} 
---

### confirmed {.value-box}
```{r}

flexdashboard::valueBox(dbGetQuery(db, 
           paste("SELECT SUM(`Casos Confirmados`)", 
                 "FROM Caso_Atualizado_Estado"))[[1]] %>%
             number(big.mark = ".", decimal.mark = ","),
icon = "fa-hospital",
caption = "Total de Casos Confirmados",
color = "#F08080"
)
```

### Mortes {.value-box}
```{r}
flexdashboard::valueBox(dbGetQuery(db, 
           paste("SELECT SUM(`Óbitos`)", 
                 "FROM Caso_Atualizado_Estado"))[[1]] %>%
             number(big.mark = ".", decimal.mark = ","),
icon = "far fa-frown-open",
caption = "Total de Óbitos",
color = "#A9A9A9")
```

### Letalidade {.value-box}
```{r}
flexdashboard::valueBox(
  dbGetQuery(db,
             paste("SELECT ",
             "SUM(`Óbitos`) AS `Óbitos`, 
             SUM(`Casos Confirmados`) AS `Casos Confirmados`",
             "FROM Caso_Atualizado_Estado")) %>%
    summarise(Letalidade = round((`Óbitos`/`Casos Confirmados`)*100, 2) %>%
                str_replace("[.]", ",") %>% 
                paste0("%")),
  icon = "fas fa-skull",
  caption = "Letalidade",
color = "#DDA0DD")     
```

### População {.value-box}
```{r}
flexdashboard::valueBox(
  dbGetQuery(db, 
             paste("SELECT SUM(`População Estimada`)",
                   "FROM Caso_Atualizado_Estado"))[[1]] %>%
    number(big.mark = ".", decimal.mark = ","),
  icon = "fas fa-users",
  caption = "População Brasileira",
  color = "#90EE90")
```

Column {data-width=500 .tabset .tabset-fade} 
---

```{r funcao_Mapa_Brasileiro, include=FALSE}

```


### **Mapeamento no Brasil** {.no-padding}    
```{r }
#renderLeaflet({
    pal <- colorNumeric(palette = "YlOrRd",
                        #,c(low = "yellow", high = "red"), 
                    domain = 
                      dbGetQuery(db, 
                                 paste("SELECT",
                                       "`Casos Confirmados por 100 mil Hab`", 
                                       "FROM Caso_Atualizado_Estado"))[[1]])

ima_png <- makeIcon(iconUrl = "https://viasoft.com.br/wp-content/uploads/2020/03/Website_Covid-19_COVID-19_Icon.png",
                    iconWidth = 40,
                    iconHeight = 40)

dbGetQuery(db, paste("SELECT",
                     "Data, `Casos Confirmados`, `Óbitos`,", 
                     "`População Estimada`,", 
                     "`Casos Confirmados por 100 mil Hab`,",
                     "`Óbitos por 100 mil Hab`,",
                     "Letalidade, Estado,",
                     "Latitude, Longitude,",
                     "RANK() OVER (ORDER BY  `Casos Confirmados por 100 mil Hab` DESC) `Rank Casos Confirmados por 100 mil Hab`,",
                     "RANK() OVER (ORDER BY  Letalidade DESC) `Rank Letalidade`",
                     "FROM Caso_Atualizado_Estado",
                     "INNER JOIN Local_Estado
                     ON Local_Estado.`Código UF`=
                     Caso_Atualizado_Estado.`Código do Estado (IBGE)`")) %>%
  inner_join(dbGetQuery(db, paste("SELECT Estado, 
                                  `Novos Casos`,
                                  `Novos Óbitos` FROM
                                  Caso_Novos_Estados",
                                  "INNER JOIN Local_Estado",
                                  "ON Local_Estado.UF=Caso_Novos_Estados.UF",
                                  "WHERE is_last GLOB '1'"
                     )),
             by = "Estado") %>%
  as_tibble() %>%
  mutate(Data = as.Date(Data)) %>%
  leaflet(options = leafletOptions(minZoom = 4, maxZoom = 12)) %>%
  #addTiles(group = "OSM") %>%
  #addProviderTiles("NASAGIBS.ViirsEarthAtNight2012",
  #                 group="NASAGIBS") %>%
  setMaxBounds(lng1 = -90, lat1 = -45, lng2 = -10, lat2 = 40) %>%
  addProviderTiles("CartoDB.DarkMatter", group= "CartoDB",
                   options = providerTileOptions(noWrap = TRUE)) %>%
  addCircleMarkers(~Longitude,
                   ~Latitude,
                   color=~pal(`Casos Confirmados por 100 mil Hab`),
                   stroke = FALSE, 
                   fillOpacity = 0.75,
                   radius =~sqrt(`Casos Confirmados por 100 mil Hab`/20),
                   group = "Casos") %>%
  addLegend("bottomright",
            pal = pal,
            value =~`Casos Confirmados por 100 mil Hab`,
            labFormat = labelFormat(digits = 1, big.mark = "."),
            title = paste0("Casos Confirmados", "<br>(100 Mil Habitantes)"),
            group = "Casos") %>%
  addMarkers(~Longitude, ~Latitude, icon = ima_png,
             popup = ~ paste("<style>
                             .main {
                             text-align: center;
                             }
                             </style>",
                             "<h3 class='main'><b>", Estado,"</b></h3>",
                             "<h5><b>Casos Confirmados </b></h5>",
                             "<b>Rank: </b>",
                             paste0(`Rank Casos Confirmados por 100 mil Hab`, "º"),
                             "<br>",
                             "<b>Por 100 Mil Habitantes: </b>",
                            number(`Casos Confirmados por 100 mil Hab`,
                            big.mark = ".", 
                            decimal.mark = ",") %>%
                              str_replace(c(",0"),""),
                            "<br>",
                            "<b>Total: </b>",
                             number(`Casos Confirmados`,
                            big.mark = ".", 
                            decimal.mark = ",") %>%
                              str_replace(c(",0"),""),
                            "<br>",
                            "<b>Novos: </b>",
                             number(`Novos Casos`,
                            big.mark = ".", 
                            decimal.mark = ",") %>%
                              str_replace(c(",0"),""),
                            "<h5><b>Mortes </b></h5>",
                            "<b>Por 100 Mil Habitantes: </b>",
                            number(`Óbitos por 100 mil Hab`,
                            big.mark = ".", 
                            decimal.mark = ",") %>%
                              str_replace(c(",0"),""),
                            "<br>",
                            "<b>Total: </b>",
                             number(`Óbitos`,
                            big.mark = ".", 
                            decimal.mark = ",") %>%
                              str_replace(c(",0"),""),
                            "<br>",
                            "<b>Novos: </b>",
                             number(`Novos Óbitos`,
                            big.mark = ".", 
                            decimal.mark = ",") %>%
                              str_replace(c(",0"),""),
                            "<h5><b>Letalidade </b></h5>",
                            "<b>Rank: </b>",
                            paste0(`Rank Letalidade`,"º"),
                            "<br>",
                            "<b>Percentual: </b>",
                            str_replace(as.character(Letalidade*100), "[.]", ",") %>%
                              paste0("%"),
                            "<h5><b>Outras Informações </b></h5>",
                             "<b>População Estimada: </b>",
                            number(`População Estimada`,
                            big.mark = ".", 
                            decimal.mark = ",") %>%
                              str_replace(c(",0"),""),
                             "<br>",
                             "<br>",
                             "<i><b>Atualização: </b>",
                             format(Data, '%d/%m/%Y'),"</i>"),
                     label =~paste(Estado))
#})

```

### **Mapeamento nas Cidades** {.no-padding}
```{r}
pal <- colorNumeric(#c("#6495ED", "#4169E1", "#DAA520",
                      #  "#B8860B", "#B22222", "#8B0000"),
                      c("yellow", "#FFA500",  "#8B2252"), 
                    domain = dbGetQuery(db, paste("SELECT ",
                     "ROUND(`Caso por 100 Mil Habitantes`)",
                     "FROM Caso_Acum_Cidade",
                     "WHERE is_last==1 "))[[1]])

ima_png <- makeIcon(iconUrl = file.path(path, "covid_corona_virus.png"),
                    iconWidth = 40,
                    iconHeight = 40)

dbGetQuery(db, paste("SELECT DISTINCT",
                      "Cidade_UF, MAX(Data) AS `Data Novo`, 
                      `Novos Casos`, 
                      `Novos Óbitos`, Latitude, Longitude",
                      "FROM Caso_Novos_Cidades",
                     "INNER JOIN Local_Cidade ",
                      "ON Local_Cidade.`Código da Cidade`=Caso_Novos_Cidades.`Código da Cidade` ",
                      "WHERE is_last==1",
                     "GROUP BY Cidade_UF"
                      )) %>%
  as_tibble() %>%
  inner_join(dbGetQuery(db, paste("SELECT ",
                     "Cidade_UF, MAX(Data) AS `Data Acum`,
                     `População Estimada`, 
                     `Casos Acumulado`, `Óbitos Acumulado`,
                     Letalidade*100 AS Letalidade,
                     ROUND(`Caso por 100 Mil Habitantes`) AS
                     `Caso por 100 Mil Habitantes`,
                     ROUND((`Óbitos Acumulado`/`População Estimada`)*100000) AS `Mortes por 100 Mil Habitantes`,",
                     "RANK() OVER (ORDER BY `Caso por 100 Mil Habitantes` DESC) `Rank Casos Confirmados por 100 mil Hab`,",
                     "RANK() OVER (ORDER BY  Letalidade DESC) `Rank Letalidade`",
                     "FROM Caso_Acum_Cidade",
                     "WHERE is_last==1 ",
                     "GROUP BY Cidade_UF"
                     )),
             by = "Cidade_UF") %>%
  as_tibble() %>%
  mutate(`Data Novo` = as.Date(`Data Novo`),
         `Data Acum` = as.Date(`Data Acum`)) %>%

  leaflet(options = leafletOptions(minZoom = 4, maxZoom = 12)) %>%
  setMaxBounds(lng1 = -90, lat1 = -45, lng2 = -10, lat2 = 40) %>%
  addProviderTiles(providers$Esri.NatGeoWorldMap) %>%
  addCircleMarkers(~Longitude,
                   ~Latitude,
                   color=~pal(`Caso por 100 Mil Habitantes`),
                   stroke = T, 
                   fillOpacity = 0.8,
                   radius =~sqrt(`Caso por 100 Mil Habitantes`/5),
                   clusterOptions = markerClusterOptions()) %>%
    addLegend("bottomright",
            pal = pal,
            values =~`Caso por 100 Mil Habitantes`,
            labFormat = labelFormat(digits = 1, big.mark = "."),
            title = paste0("Casos Confirmados", "<br>(100 Mil Habitantes)")) %>%
  addMarkers(~Longitude, ~Latitude, icon = ima_png,
             clusterOptions = markerClusterOptions(), 
             popup = ~ paste0("<style>
                             .main {
                             text-align: center;
                             }
                             </style>",
                              "<h4 class='main'><b>", 
                              Cidade_UF,
                              "</b></h4>",
                             "<h5><b>Casos Confirmados </b></h5>",
                             "<b>Rank: </b>",
                             `Rank Casos Confirmados por 100 mil Hab` %>% 
                               number(big.mark = ".", 
                                      decimal.mark = ",") %>%
                               str_replace(c(",0"),"")%>%
                               paste0("º"),
                             "<br>",
                             "<b>Novos: </b>",
                             `Novos Casos` %>%
                               number(big.mark = ".", 
                                      decimal.mark = ",") %>%
                               str_replace(c(",0"),""),
                             "<br>",
                             "<b>Acumulado: </b>",
                             `Casos Acumulado` %>%
                               number(big.mark = ".", 
                                      decimal.mark = ",") %>%
                               str_replace(c(",0"),""),
                             "<br>",
                             "<b>Por 100 Mil Habitantes: </b>",
                            number(`Caso por 100 Mil Habitantes`,
                            big.mark = ".", 
                            decimal.mark = ",") %>%
                              str_replace(c(",0"),""),
                             "<h5><b>Mortos </b></h5>",
                             "<b>Novos: </b>",
                             `Novos Óbitos` %>%
                              number(big.mark = ".", 
                                      decimal.mark = ",") %>%
                               str_replace(c(",0"),""),
                             "<br>",
                             "<b>Acumulado: </b>", 
                             `Óbitos Acumulado` %>%
                              number(big.mark = ".", 
                                      decimal.mark = ",") %>%
                               str_replace(c(",0"),""),
                            "<br>",
                             "<b>Por 100 Mil Habitantes: </b>",
                            number(`Mortes por 100 Mil Habitantes`,
                            big.mark = ".", 
                            decimal.mark = ",") %>%
                              str_replace(c(",0"),""),
                             "<h5><b>Letalidade </b></h5>",
                             "<b>Percentual: </b>",
                            Letalidade %>%
                             str_replace(
                               "[.]", 
                               ",") %>%
                              paste0("%"),
                             "<br>",
                             "<b>Rank: </b>",
                             `Rank Letalidade` %>%
                              number(big.mark = ".", 
                                      decimal.mark = ",") %>%
                               str_replace(c(",0"),"") %>%
                              paste0("º"),
                             "<h5><b>Outras Informações </b></h5>",
                             "<b>População Estimada: </b>",
                             `População Estimada` %>%
                                number(big.mark = ".", 
                                      decimal.mark = ",") %>%
                               str_replace(c(",0"),""),
                             "<br>",
                             "<br>",
                             "<i><b>Atualização: </b>",
                             format(`Data Acum`, '%d/%m/%Y</i>')
                             ),
             label =~paste(Cidade_UF),
             group = "Cidade_UF") %>%
  addResetMapButton() %>%
  addSearchFeatures(
    targetGroups = 'Cidade_UF',
    options = searchFeaturesOptions(zoom = 13,
                                    openPopup = TRUE,
                                    firstTipSubmit = TRUE,
                                    autoCollapse = TRUE,
                                    hideMarkerOnCollapse = TRUE)
    )

```



```{r eval=FALSE, include=FALSE}

#Column {data-width=500} 
#---

### **Algumas Fontes** {.no-padding}
  
```

```{r fig.height=28, fig.width=28, message=FALSE, warning=FALSE, eval=FALSE, include=FALSE}
#### fdf
n <- dbGetQuery(db, paste("SELECT fonte AS Fontes,
                     Frequencia AS `Frequência de Dados Coletados` 
                     FROM Fontes",
                     "ORDER BY `Frequência de Dados Coletados`  DESC")) %>%
  nrow()

dbGetQuery(db, paste("SELECT fonte AS Fontes,
                     Frequencia AS `Frequência de Dados Coletados` 
                     FROM Fontes",
                     "ORDER BY `Frequência de Dados Coletados`  DESC")) %>%
  ggplot(aes(label = Fontes, size = `Frequência de Dados Coletados`,
             colour = factor(sample.int(10, n, replace = TRUE))
             ))+
  geom_text_wordcloud(shape =  "diamond")+
  scale_size_area(max_size = 50)+
  theme_minimal()


```

Ocorrência no País {data-icon="fa-globe-americas"} 
===

Column {.tabset .tabset-fade}
---

```{r ggcal Modificado, include=FALSE}
ggcal <- function(dates, fills) {
  # get ordered vector of month names
  months <- format(seq(as.Date("2016-01-01"), as.Date("2016-12-01"), by="1 month"), "%B")

  # get lower and upper bound to fill in missing values
  mindate <- as.Date(format(min(dates), "%Y-%m-01"))
  maxdate <- (seq(as.Date(format(max(dates), "%Y-%m-01")), length.out = 2, by="1 month")-1)[2]
  # set up tibble with all the dates.
  filler <- tibble(date = seq(mindate, maxdate, by="1 day"))

  t1 <- tibble(date = dates, fill=fills) %>%
    right_join(filler, by="date") %>% # fill in missing dates with NA
    mutate(dow = as.numeric(format(date, "%w"))) %>%
    mutate(month = format(date, "%B")) %>%
    mutate(woy = as.numeric(format(date, "%U"))) %>%
    mutate(year = as.numeric(format(date, "%Y"))) %>%
    mutate(month = factor(month, levels=months, ordered=TRUE)) %>%
    arrange(year, month) %>%
    mutate(monlabel=month)

  if (length(unique(t1$year))>1) { # multi-year data set
    t1$monlabel <- paste(t1$month, t1$year)
  }

  t2 <- t1 %>%
    mutate(monlabel = str_to_title(monlabel),
           monlabel = factor(monlabel, ordered=TRUE)) %>%
    mutate(monlabel = fct_inorder(monlabel)) %>%
    mutate(monthweek = woy-min(woy),
           y=max(monthweek)-monthweek+1)

weekdays <- c("D", "S", "T", "Q", "Q", "S", "S")
ggplot(t2, aes(dow, y, fill=fill,
               text = paste("Pessoas:", fill,
                            "<br>",
                            "Mês:", monlabel,
                            "<br>",
                            "Dia da semana:", weekdays))
       ) +
  geom_tile(color="gray80") +
  facet_wrap(~monlabel, ncol=3, scales="free") +
  scale_x_continuous(expand=c(0,0), position="top",
                     breaks=seq(0,6), labels=weekdays) +
  scale_y_continuous(expand=c(0,0)) +
  theme(panel.background=element_rect(fill=NA, color=NA),
        strip.background = element_rect(fill=NA, color=NA),
        strip.text.x = element_text(hjust=0, face="bold"),
        legend.title = element_blank(),
        axis.ticks=element_blank(),
        axis.title=element_blank(),
        axis.text.y = element_blank(),
        strip.placement = "outsite")
}
```

```{r}
#### Funcao Calendario como ano e ocorrencia ####

Novos_Calend <- function(ocorrencia, ano){
 situacao <- c("Novos Casos", "Novos Óbitos") 
 
 df <- dbGetQuery(db,
                  paste("SELECT Data,",
                        paste0("SUM","(`",
                               str_subset(situacao,
                                           ocorrencia),
                                "`)", " AS ", "`", 
                                "Novos Casos", "`"),
                         "FROM Caso_Novos_Estados",
                         paste0("WHERE Data LIKE '%", ano,
                                "%'"),
      "GROUP BY Data")) %>%
  as_tibble() %>%
    mutate(Data = as.Date(Data)) 
 
 Cor <- scale_fill_gradientn(colours = colorspace::
                         diverge_hcl(7,
                                     palette = "Blue-Red"), 
                       #na.value = NA,
                       label = 
                         label_number(scale = 1, suffix = "",
                                      big.mark = ".",
                                      decimal.mark = ","),
                       name = "Pessoas")
 
 #library("highcharter")
 
 ggcal(df$Data, df[[2]])+
  Cor+
  ggtitle(paste("Novos", ocorrencia, "em",  ano, "por dia")) 
   

 
 
}

```

```{r eval=FALSE, include=FALSE}
#### Função de grafico de acumulada ####

graf_acum <- function(Ocorrencia){
  
  graf <- dbGetQuery(db, paste("SELECT",
                     "Data, ",
                     paste0("SUM","(`",
                                Ocorrencia," Acum.", 
                                "`)"),
                     " FROM Caso_Acum_Estados",
                     "GROUP BY Data")) %>%
  pivot_longer(-Data, names_to = "Situação", values_to = "Pessoas") %>%
  mutate(Data = as.Date(Data)) %>%
  arrange(Data)%>%
  ggplot(aes(x = Data,
             y = Pessoas,
             text = paste0("<b>Data: </b>", 
                           format(Data, '%d/%m/%Y'), "<br>",
                           "<b>Pessoas: </b>",
                           number(Pessoas, big.mark = ".",
                                  decimal.mark = ",") %>%
                              str_replace(c(",0"),""))
             ))+
  geom_col(fill = "#F08080")+
  #theme_classic()+
  #geom_area(colour = "#F08080")+
  theme_minimal_hgrid()+
  scale_x_date(date_labels = "%b/%Y")+
  labs(y = "Pessoas", 
       x = "Data",
       title = paste0("<b>Casos acumulados por dia</b>"))
  
  ggplotly(graf, 
         tooltip = c("text"), 
         dynamicTicks = TRUE) %>%
  rangeslider() %>%
  layout(hovermode = "x",
         showlegend = FALSE,
         xaxis = list(type = 'date',
                      tickformat = "%B <br>%Y"),
         font= list(family = "sans serif",
                               size = 15,
                               color = 'black'))
  
}

```



### **Calendário de Casos em 2020**
```{r}
Novos_Calend("Casos", "2020")
```

### **Calendário de Casos em 2021**
```{r}
Novos_Calend("Casos", "2021")
```

### **Calendário de Casos em 2022**
```{r}
Novos_Calend("Casos", "2022")
```


### **Casos acumulados por dia** {.no-title}
```{r}
  graf <- dbGetQuery(db, paste("SELECT",
                     "Data, ",
                     paste0("SUM","(`", 
                                "Casos Acum.", 
                                "`)"),
                     " FROM Caso_Acum_Estados",
                     "GROUP BY Data")) %>%
  pivot_longer(-Data, names_to = "Situação", values_to = "Pessoas") %>%
  mutate(Data = as.Date(Data)) %>%
  arrange(Data)%>%
  ggplot(aes(x = Data,
             y = Pessoas,
             text = paste0("<b>Data: </b>", 
                           format(Data, '%d/%m/%Y'), "<br>",
                           "<b>Pessoas: </b>",
                           number(Pessoas, big.mark = ".",
                                  decimal.mark = ",") %>%
                              str_replace(c(",0"),""))
             ))+
  geom_col(fill = "#F08080")+
  #theme_classic()+
  #geom_area(colour = "#F08080")+
  theme_minimal_hgrid()+
  scale_x_date(date_labels = "%b/%Y")+
  labs(y = "Pessoas", 
       x = "Data",
       title = paste0("<b>Casos acumulados por dia</b>"))

ggplotly(graf, 
         tooltip = c("text"), 
         dynamicTicks = TRUE)  %>%
  rangeslider() %>%
  layout(hovermode = "x",
         showlegend = FALSE,
         xaxis = list(type = 'date',
                      tickformat = "%B <br>%Y"),
         font= list(family = "sans serif",
                               size = 15,
                               color = 'black')) %>%
    config(locale = "pt-br")
```

Column {.tabset .tabset-fade}
---

### **Calendário de Óbitos em 2020**
```{r}
Novos_Calend("Óbitos", "2020")
```

### **Calendário de Óbitos em 2021**
```{r}
Novos_Calend("Óbitos", "2021")
```

### **Calendário de Óbitos em 2022**
```{r}
Novos_Calend("Óbitos", "2022")
```

### **Mortes acumuladas por dia** {.no-title}
```{r}
  graf <- dbGetQuery(db, paste("SELECT",
                     "Data, ",
                     paste0("SUM","(`", 
                                "Óbitos Acum.", 
                                "`)"),
                     " FROM Caso_Acum_Estados",
                     "GROUP BY Data")) %>%
  pivot_longer(-Data, names_to = "Situação", values_to = "Pessoas") %>%
  mutate(Data = as.Date(Data)) %>%
  arrange(Data)%>%
  ggplot(aes(x = Data,
             y = Pessoas, 
             fill = `Situação`,
             text = paste0("<b>Data: </b>",
                           format(Data, '%d/%m/%Y'), "<br>",
                           "<b>Pessoas: </b>",
                           number(Pessoas, big.mark = ".",
                                  decimal.mark = ",") %>%
                             str_replace(c(",0"),""))))+
  geom_col(fill = "#2F4F4F")+
  #theme_classic()+
  theme_minimal_hgrid()+
  labs(y = "Pessoas", 
       x = "Data",
       title = "<b>Mortes acumuladas por dia</b>") 

ggplotly(graf, 
                 tooltip = c("text"), 
                 dynamicTicks = TRUE) %>%
    rangeslider() %>%
     layout(hovermode = "x",
            xaxis = list(type = 'date',
                      tickformat = "%B <br>%Y"),
                    showlegend = FALSE,
         font= list(family = "sans serif",
                               size = 15,
                               color = 'black')) %>%
    config(locale = "pt-br")
```


Referências {data-icon="fa-clipboard"}
===

<h3>**Fontes**</h3>
      
  * <h4>**Quem mais utiliza os Bancos de Dados:**</h4>
    * https://github.com/turicas/covid19-br/blob/master/clipping.md

  * <h4>**Dados que inspirarão em alguns gráficos:**</h4>  
    * https://brasil.io/covid19/

  * <h4>**Sobre o projeto do banco de dados utilizado:**</h4>  
    * https://blog.brasil.io/2020/03/23/dados-coronavirus-por-municipio-mais-atualizados/
 
  * <h4>**Banco de dados**</h4> 
    * <h5>*Boletim:*</h5>  
      * https://brasil.io/dataset/covid19/boletim/
    * <h5>*Caso:*</h5>
      * https://brasil.io/dataset/covid19/caso/
    * <h5>*Caso_full:*</h5>
      * https://brasil.io/dataset/covid19/caso_full/
    * <h5>*Coordenadas dos Estados:*</h5>
      * https://raw.githubusercontent.com/kelvins/Municipios-Brasileiros/main/csv/estados.csv   
    * <h5>*Coordenadas dos Municípios:*</h5>
      * https://raw.githubusercontent.com/kelvins/Municipios-Brasileiros/main/csv/municipios.csv
    
    
```{r observações, include=FALSE}
#dbDisconnect(db)
#rm(list = ls())

#https://github.com/wcota/covid19br
#https://datastudio.google.com/embed/u/0/reporting/2f2537fa-ac23-4f08-8741-794cdbedca03/page/CPFTB

# comparação com as demais mortes
## Grafico de linha 
## waffle (acada 100 mortes n são se covid) https://github.com/hrbrmstr/waffle
## https://jkunst.com/highcharter/
```
    
    
    